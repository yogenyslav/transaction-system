# Тестовое задание

## Задача

Нужно реализовать транзакционную систему.

- Invoice -> человеку зачисляются средства по ручке "/invoice" с такими параметрами в теле, как код валюты ("USDT", "RUB", "EUR", etc.), количество средств (число с плавающей точкой), номер кошелька или карты.
- Withdraw -> человек выводит средства со своего баланса по валюте, которую он выбрал по ручке "/withdraw" с такими параметрами в теле, как код валюты, количество средств, номер кошелька или карты куда зачисляются средства.
- В транзакционной системе должны быть статусы транзакции ("Error", "Success", "Created"). Статусы "Error" и "Success" должны быть финальными.
- Должна быть реализована ручка по получению актуального и замороженного баланса клиентов. Актуальный баланс это тот баланс, который можно вывести. Замороженный баланс - это тот баланс, который, находится в ожидании (со статусом "Created").
- Рекомендуется использовать Kafka/RabbitMQ как брокер сообщений.
- База данных должны быть PostgreSQL.
- Баланс клиента не может уйти ниже нуля.

## Реализация

### Запуск решения

Для запуска необходима утилита make и docker-compose.

```bash
1. git clone
2. cd transaction-system
3. make docker
```

### Cтек технологий

- Go 1.21.5
- Postgres 15
- Docker и docker-compose
- RabbitMQ 3.12
- Go Fiber (в качестве фреймворка для http)
- PGX (в качестве драйвера для работы с Postgres)
- Testify
- CleanEnv (для работы с переменными окружения)

### Струтура проекта

**account_service** - основной сервис, отвечающий требованиям задачи\
**transaction_service_example** - пример сервиса, который может быть подключен к системе (например, банк или сервис, который с ним взаимодействует)

### Описание бизнес-логики

По умолчанию в системе создается один аккаунт с id = 1.\
Все операции считаются в рублях или конвертируются в рубли по актуальному курсу (курсы валют получаются из стороннего сервиса).

- **POST /invoice**
  - создается транзакция со статусом **Created** и суммой, равной сумме запроса
  - сумма добавляется к замороженному балансу клиента и становится недоступной для вывода
  - затем транзакция отправляется в очередь **transaction_queue** и обрабатывается сторонним сервисом (например, банком)
  - после обработки транзакции статус меняется на **Success** или **Error** в зависимости от результата обработки
  - в случае **Error** сумма транзакции не зачисляется на баланс клиента и вычитается из недоступной для вывода
  - в случае **Success** сумма транзакции зачисляется на баланс клиента и становится доступной для вывода
  - **пример запроса**:

  ```json
    {
        "accountId": 1,
        "amount": 10,
        "currency": "usd"
    }
  ```

- **POST /withdraw**
  - создается транзакция со статусом **Created** и суммой, равной сумме запроса
  - сумма вычитается из балансе клиента, если не превышает его, и становится недоступной для вывода
  - затем транзакция отправляется в очередь **transaction_queue** и обрабатывается сторонним сервисом (например, банком)
  - после обработки транзакции статус меняется на **Success** или **Error** в зависимости от результата обработки
  - в случае **Error** сумма возвращается на баланс клиента и становится доступной для вывода
  - в случае **Success** сумма транзакции вычитается из замороженного баланса клиента
  - **пример запроса**:

  ```json
    {
        "accountId": 1,
        "amount": 50,
        "currency": "RUB"
    }
    ```

- **GET /list**
  - возвращает список всех счетов клиентов с актуальным и замороженным балансом
  - **пример ответа**:

  ```json
    [
        {
            "id": 1,
            "balance": 831.3240000000001,
            "frozen": 50,
            "createdAt": "2024-01-14T13:48:19.336383Z",
            "updatedAt": "2024-01-14T14:16:07.700654Z"
        }
    ]
  ```

### Запуск тестов

```bash
make test
```
